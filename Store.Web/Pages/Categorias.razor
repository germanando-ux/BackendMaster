@page "/categorias"
@using System.Net.Http.Json
@inject HttpClient Http
@inject IJSRuntime JS

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3 class="mb-0">Gestión de Categorías</h3>
            <button class="btn btn-info" @onclick="AbrirModal">
                <i class="bi bi-plus-circle"></i> Nueva Categoría
            </button>
        </div>
        <div class="card-body">
            @if (categorias == null)
            {
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p>Cargando categorías...</p>
                </div>
            }
            else
            {
              @*   <div class="mb-3 text-end">
                  
                </div> *@
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var cat in categorias)
                        {
                            <tr>
                                <td>@cat.Id</td>
                                <td>@cat.Name</td>
                                <td class="text-center">
                                    @* <button class="btn btn-sm btn-info me-2">Editar</button> *@
                                    <button class="btn btn-sm btn-info me-2" @onclick="() => EditarCategoria(cat)">
                                        <i class="bi bi-pencil"></i> Editar
                                    </button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => ConfirmarEliminacion(cat.Id)">
                                        <span class="bi bi-trash" aria-hidden="true"></span> Eliminar
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>
</div>
@* FORMULARIO MODAL DE EDICIÓN DE CATEGORÍAS *@
@if (mostrarModal)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.2); backdrop-filter: blur(2px);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <EditForm Model="@categoriaActual" OnValidSubmit="GuardarCategoria">
                    <DataAnnotationsValidator />

                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">@tituloModal</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CerrarModal"></button>
                    </div>

                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label font-weight-bold">Nombre</label>
                            <InputText @bind-Value="categoriaActual.Name" class="form-control" placeholder="Escribe el nombre..." />
                            <ValidationMessage For="@(() => categoriaActual.Name)" class="text-danger" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label font-weight-bold">URL Imagen</label>
                            <InputText @bind-Value="categoriaActual.Image" class="form-control" placeholder="http://..." />
                        </div>

                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CerrarModal">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Guardar Cambios
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {

    private List<Category>? categorias;
    private Category categoriaActual = new Category();
    private string tituloModal = "Nueva Categoría";
    private bool mostrarModal = false;


    protected override async Task OnInitializedAsync()
    {
        await CargarCategorias();
    }

    private async Task CargarCategorias()
    {
        try
        {
            // OJO: Asegúrate de que tu endpoint en la API sea "categories"
            categorias = await Http.GetFromJsonAsync<List<Category>>("categories");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar: {ex.Message}");
        }
    }

    private async Task ConfirmarEliminacion(int? id)
    {
        // Esto abre la ventanita típica del navegador con "Aceptar" o "Cancelar"
        var confirmado = await JS.InvokeAsync<bool>("confirm", $"¿Seguro que quieres eliminar la categoría con ID {id}?");

        if (confirmado)
        {
            // Si el usuario pulsa Aceptar, entonces sí llamamos al borrado real
            await EliminarCategoria(id);
        }
    }
    private async Task EliminarCategoria(int? id)
    {
        // 1. Lanzamos la petición DELETE a la API
        // Asumiendo que tu API escucha en "api/categories/{id}" o "categories/{id}"
        var response = await Http.DeleteAsync($"categories/{id}");
        if (response.IsSuccessStatusCode)
        {
            // 2. Si la API responde OK (200 o 204), refrescamos la lista
            await CargarCategorias();
            Console.WriteLine($"Categoría {id} eliminada de la base de datos.");
        }
        else
        {
            // LLAMADA ENCAPSULADA:
            // Usamos nuestra clase Notificaciones.
            // Le pasamos 'JS' (que es el IJSRuntime que ya tienes inyectado en la página)
            await Notificaciones.MostrarToast(JS, "No se puede eliminar", "Existen productos asociados a esta categoría");
        }        
    }

    #region ModalEdicionCategorias


    // Método para abrir el modal (lo llamará el botón "Nueva Categoría")
    private void AbrirModal()
    {
        // Limpiamos el objeto por si había algo de antes
        // Al poner Id = 0, el JSON llevará un número y la API lo aceptará
        categoriaActual = new Category { Id = 0, Name = "" };
        
        tituloModal = "Nueva Categoría";
        mostrarModal = true;
    }

    // Método para cerrar el modal
    private void CerrarModal()
    {
        mostrarModal = false;
    }

    private void EditarCategoria(Category cat)
    {
        // Clonamos la categoría para no modificar la de la lista directamente
        // hasta que el usuario le dé a "Guardar"
        categoriaActual = new Category
        {
            Id = cat.Id,
            Name = cat.Name,
            Image = cat.Image
        };

        tituloModal = "Editar Categoría";
        mostrarModal = true;
    }


    private async Task GuardarCategoria()
    {
        try
        {
            HttpResponseMessage response;
            // Si el Id es 0 o nulo, significa que es una categoría NUEVA
            if (categoriaActual.Id == null || categoriaActual.Id == 0)
            {
                // Enviamos un POST para CREAR
                response = await Http.PostAsJsonAsync("categories", categoriaActual);
            }
            else
            {
            // Enviamos un PUT para EDITAR (usando el Id en la URL)
            response = await Http.PutAsJsonAsync($"categories/{categoriaActual.Id}", categoriaActual);
            }

            if (response.IsSuccessStatusCode)
            {
                // Si la API responde bien:
                await Notificaciones.MostrarToast(JS, "¡Logrado!", "Categoría guardada correctamente", "success");
            
                mostrarModal = false;      // Cerramos el modal
                await CargarCategorias();  // Refrescamos la lista de la tabla
            }
            else
            {
                // Si la API nos devuelve un error (por ejemplo, 400 o 500)
                await Notificaciones.MostrarToast(JS, "Error", "No se pudo guardar en el servidor");
            }
        }
        
        catch (Exception ex)
        {
        // Por si falla la conexión o hay un error inesperado
        await Notificaciones.MostrarToast(JS, "Error crítico", ex.Message);
        }
    }
#endregion

}